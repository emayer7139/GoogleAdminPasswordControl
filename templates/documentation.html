{% extends "base.html" %}

{% block title %}Admin Documentation - ResetApp{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='documentation.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="doc-hero">
    <div>
      <h1 class="display-5 mb-2">Admin Documentation</h1>
      <p class="text-muted mb-0">
        A compact admin handbook covering roles, workflows, configuration, and support tools.
      </p>
    </div>
  </div>

  <div class="doc-layout mt-4">
    <aside class="doc-stack">
      <div class="doc-card">
        <h2 class="h6 text-uppercase">Contents</h2>
        <ol>
          <li><a href="#quick-start">Quick Start</a></li>
          <li><a href="#roles">Roles and Access</a></li>
          <li><a href="#role-matrix">Role Matrix</a></li>
          <li><a href="#workflow">Password Reset Workflow</a></li>
          <li><a href="#classroom">Classroom Sync</a></li>
          <li><a href="#admin-console">Admin Console Tabs</a></li>
          <li><a href="#admin-menu">Admin Menu</a></li>
          <li><a href="#bug-reports">Bug Reporting</a></li>
          <li><a href="#theme">Theme Preference</a></li>
          <li><a href="#retention">Data Retention</a></li>
          <li><a href="#config">Configuration Reference</a></li>
          <li><a href="#errors">Common Errors</a></li>
        </ol>
      </div>
      <div class="doc-card">
        <h2 class="h6 text-uppercase">Where to Configure</h2>
        <ul>
          <li><a href="https://admin.google.com/ac/owl/list?tab=apps" target="_blank">Google Admin Console - APIs</a></li>
          <li><a href="https://console.cloud.google.com/apis/library/admin.googleapis.com" target="_blank">Admin SDK (Directory API)</a></li>
          <li><a href="https://console.cloud.google.com/apis/library/classroom.googleapis.com" target="_blank">Classroom API</a></li>
          <li><a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank">OAuth Consent Screen</a></li>
        </ul>
      </div>
    </aside>

    <div class="doc-content">
      <section id="quick-start" class="doc-section">
        <h2 class="h4">Quick Start (5 steps)</h2>
        <ol class="fs-5">
          <li><strong>OAuth Client</strong>: Create OAuth 2.0 (Web) client and set redirect URI to <code>/oauth2callback</code>.</li>
          <li><strong>Service Account</strong>: Create service account JSON and enable domain-wide delegation.</li>
          <li><strong>Scopes</strong>: Whitelist Admin SDK + Classroom scopes in Google Admin Console.</li>
          <li><strong>Environment</strong>: Set <code>GOOGLE_CLIENT_ID</code>, <code>GOOGLE_CLIENT_SECRET</code>, <code>SERVICE_ACCOUNT_FILE</code>, and <code>ADMIN_USER</code>.</li>
          <li><strong>Run</strong>: Install dependencies and start the app with <code>python app.py</code>.</li>
        </ol>
      </section>

      <section id="roles" class="doc-section">
        <h2 class="h4">1) Roles and Access</h2>
        <ul class="fs-5">
          <li><strong>Teacher</strong>: can reset students in their Google Classroom rosters.</li>
          <li><strong>Media Specialist</strong>: can reset students in the same school OU segment.</li>
          <li><strong>Admin</strong>: full control over students across all schools.</li>
          <li><strong>Global Admin</strong>: full control over everything (isAdmin or listed as global).</li>
        </ul>
        <p class="mb-0">
          Admin access to this console is stored in the database table <code>admin_users</code>. Global admins can
          be set via <code>GLOBAL_ADMIN_EMAILS</code> or the <code>global_admins</code> table.
        </p>
      </section>

      <section id="role-matrix" class="doc-section">
        <h2 class="h4">Role Matrix</h2>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr><th>Role</th><th>Can Reset</th><th>Scope</th><th>Notes</th></tr>
            </thead>
            <tbody>
              <tr><td>Teacher</td><td>Students</td><td>Classroom roster only</td><td>Sync button updates roster cache.</td></tr>
              <tr><td>Media Specialist</td><td>Students</td><td>Same school OU segment</td><td>Based on OU path parsing.</td></tr>
              <tr><td>Admin</td><td>Students</td><td>All schools</td><td>Listed in <code>admin_users</code> table.</td></tr>
              <tr><td>Global Admin</td><td>Everything</td><td>Domain-wide</td><td>Super admin or global list.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="workflow" class="doc-section">
        <h2 class="h4">2) Password Reset Workflow</h2>
        <ol class="fs-5">
          <li>Open the main Reset page and enter a student email.</li>
          <li>The app verifies the student is in a configured student OU or domain (see <code>STUDENT_OU_PREFIXES</code> and <code>STUDENT_EMAIL_DOMAINS</code>).</li>
          <li>Role checks are enforced:
            <ul>
              <li>Teacher: student must be in their Classroom roster.</li>
              <li>Media specialist: student must match their school OU segment.</li>
              <li>Admin/global admin: no OU restrictions.</li>
            </ul>
          </li>
          <li>The new password is generated and forced to change at next login.</li>
        </ol>
        <p class="mb-0 text-muted">Note: daily reset limits apply for non-admin roles unless approved.</p>
      </section>

      <section id="classroom" class="doc-section">
        <h2 class="h4">3) Classroom Sync (Teachers)</h2>
        <p class="fs-5">
          Teachers can sync Classroom rosters using the <em>Sync with Google Classroom</em> button.
          The app reads active courses and pulls student emails.
        </p>
        <p class="mb-0">
          Required scopes for domain-wide delegation:
        </p>
        <ul class="fs-5">
          <li><code>https://www.googleapis.com/auth/classroom.courses.readonly</code></li>
          <li><code>https://www.googleapis.com/auth/classroom.rosters.readonly</code></li>
        </ul>
      </section>

      <section id="admin-console" class="doc-section">
        <h2 class="h4">4) Admin Console Tabs</h2>
        <ul class="fs-5">
          <li><strong>Audit Logs</strong>: every reset action with outcome.</li>
          <li><strong>Login Logs</strong>: successful and failed sign-ins.</li>
          <li><strong>Students</strong>: live student search (admins only).</li>
          <li><strong>Admins</strong>: add/remove admin access.</li>
          <li><strong>Reset Requests</strong>: approve extra resets.</li>
          <li><strong>Bug Reports</strong>: view and close submitted bugs.</li>
        </ul>
        <div class="mt-3 doc-diagram">
          <p class="mb-1"><strong>Diagram:</strong> Admin Console Flow</p>
          <pre class="mb-0">
[Filters] -> [Tabs] -> [Tables] -> [Actions]
Audit     Login   Students   Admins   Requests   Bugs
          </pre>
        </div>
      </section>

      <section id="admin-menu" class="doc-section">
        <h2 class="h4">Admin Menu</h2>
        <ul class="fs-5">
          <li><strong>Home</strong>: main reset workflow.</li>
          <li><strong>What's New</strong>: release notes and changes.</li>
          <li><strong>Help</strong>: sign-in troubleshooting.</li>
          <li><strong>Support</strong>: contact options and ticket portal.</li>
          <li><strong>Report a Bug</strong>: in-app bug submission form.</li>
          <li><strong>Admin Page</strong>: console tabs for logs, users, and requests.</li>
        </ul>
      </section>

      <section id="bug-reports" class="doc-section">
        <h2 class="h4">5) Bug Reporting</h2>
        <p class="fs-5">
          Users can submit bug reports from the in-app form. Reports include title, severity, description,
          optional page, and optional screenshot.
        </p>
        <ul class="fs-5">
          <li>Reports are stored in the <code>bug_reports</code> table.</li>
          <li>Attachments are stored under <code>static/uploads/bug_reports</code>.</li>
          <li>Admins can close reports in the Admin Console.</li>
        </ul>
      </section>

      <section id="theme" class="doc-section">
        <h2 class="h4">6) Theme Preference</h2>
        <p class="fs-5">
          Theme preference is stored per user and persists across devices.
          When a user toggles theme, the server saves it to the <code>theme_preferences</code> table.
        </p>
      </section>

      <section id="retention" class="doc-section">
        <h2 class="h4">7) Data Retention</h2>
        <ul class="fs-5">
          <li><strong>Audit logs</strong>: database table <code>audit_logs</code>.</li>
          <li><strong>Login logs</strong>: database table <code>login_logs</code>.</li>
          <li><strong>Bug reports</strong>: database table <code>bug_reports</code>.</li>
          <li><strong>Theme prefs</strong>: database table <code>theme_preferences</code>.</li>
          <li><strong>Uploads</strong>: <code>static/uploads/bug_reports</code>.</li>
        </ul>
      </section>

      <section id="config" class="doc-section">
        <h2 class="h4">7) Configuration Reference</h2>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr><th>Setting</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr><td><code>ADMIN_USER</code></td><td>Super admin for domain-wide delegation.</td></tr>
              <tr><td><code>ROLE_OU_TEACHER_PREFIXES</code></td><td>Teacher OU prefixes.</td></tr>
              <tr><td><code>ROLE_OU_MEDIA_PREFIXES</code></td><td>Media specialist OU prefixes.</td></tr>
              <tr><td><code>STAFF_OU_PREFIXES</code></td><td>OU prefixes used in admin staff search.</td></tr>
              <tr><td><code>GLOBAL_ADMIN_EMAILS</code></td><td>Comma-separated global admins.</td></tr>
              <tr><td><code>RESET_LIMIT</code></td><td>Daily reset cap for non-admin roles.</td></tr>
              <tr><td><code>USE_ADHOC_SSL</code></td><td>Enable HTTPS with ad-hoc cert in dev.</td></tr>
              <tr><td><code>UPLOAD_FOLDER</code></td><td>Bug report screenshot storage path.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="errors" class="doc-section">
        <h2 class="h4">8) Common Errors</h2>
        <div class="doc-callout">
          <h5>Using ad-hoc certificates requires the cryptography library</h5>
          <p class="mb-0">Fix: install <code>cryptography</code> or set <code>USE_ADHOC_SSL=false</code>.</p>
        </div>
        <div class="doc-callout">
          <h5>403: Only authorized staff may sign in</h5>
          <p class="mb-0">Fix: confirm OU prefixes and ensure the user is in a permitted staff OU.</p>
        </div>
        <div class="doc-callout">
          <h5>Admin API error: 403</h5>
          <p class="mb-0">Fix: verify domain-wide delegation scopes and that <code>ADMIN_USER</code> is super admin.</p>
        </div>
        <div class="doc-callout">
          <h5>Classroom sync failed</h5>
          <p class="mb-0">Fix: ensure Classroom API is enabled and scopes are delegated.</p>
        </div>
        <div class="doc-callout">
          <h5>Unsupported image type</h5>
          <p class="mb-0">Fix: upload PNG, JPG, GIF, or WEBP under 5MB.</p>
        </div>
      </section>

      <div class="mt-4">
        <a href="{{ url_for('admin.admin_page') }}" class="btn btn-primary">
          Back to Admin Console
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
