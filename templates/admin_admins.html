{% extends "admin_layout.html" %}

{% set page_title = "Admins" %}

{% block admin_header %}
<div class="admin-hero d-flex flex-wrap align-items-end justify-content-between gap-3">
  <div>
    <h1 class="display-6 mb-1">Admins</h1>
    <p class="text-muted mb-0">Manage admin access and global admin assignments.</p>
  </div>
</div>
{% endblock %}

{% block admin_body %}
<div class="admin-panel mt-3">
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <h3 class="h5">Current Admins</h3>
      <input id="search-admins" class="form-control mb-3" placeholder="Filter existing admins" />
      <ul class="list-group mb-3" id="list-admins">
        {% for email in admin_users %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ email }}
            {% if email != user.email %}
              <form method="post" action="{{ url_for('admin.remove_admin') }}"
                    onsubmit="return confirm('Remove {{ email }}?')">
                <input type="hidden" name="email" value="{{ email }}" />
                <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                <button class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-12 col-lg-6">
      <h3 class="h5">Add Staff as Admin</h3>
      <input id="staff-search" class="form-control mb-2" placeholder="Type staff name or email" />
      <ul class="list-group mb-3" id="staff-suggestions"></ul>
      <form id="add-admin-form" method="post" action="{{ url_for('admin.add_admin') }}"
            onsubmit="return confirm('Add ' + document.getElementById('new-admin-email').value + ' as admin?')">
        <input type="hidden" id="new-admin-email" name="email" />
        <input type="hidden" name="csrf_token" value="{{session['csrf_token'] }}" />
        <button id="add-admin-btn" class="btn btn-success" disabled>Add Admin</button>
      </form>
    </div>

    {% if role == 'global_admin' %}
    <div class="col-12 col-lg-6">
      <h3 class="h5">Current Global Admins</h3>
      <input id="search-global-admins" class="form-control mb-3" placeholder="Filter global admins" />
      <ul class="list-group mb-3" id="list-global-admins">
        {% for email in global_admins %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ email }}
            {% if email != user.email %}
              <form method="post" action="{{ url_for('admin.remove_global_admin') }}"
                    onsubmit="return confirm('Remove {{ email }} as global admin?')">
                <input type="hidden" name="email" value="{{ email }}" />
                <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                <button class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-12 col-lg-6">
      <h3 class="h5">Add Staff as Global Admin</h3>
      <input id="global-search" class="form-control mb-2" placeholder="Type staff name or email" />
      <ul class="list-group mb-3" id="global-suggestions"></ul>
      <form id="add-global-form" method="post" action="{{ url_for('admin.add_global_admin') }}"
            onsubmit="return confirm('Add ' + document.getElementById('new-global-email').value + ' as global admin?')">
        <input type="hidden" id="new-global-email" name="email" />
        <input type="hidden" name="csrf_token" value="{{session['csrf_token'] }}" />
        <button id="add-global-btn" class="btn btn-warning" disabled>Add Global Admin</button>
      </form>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
  function makeSearch(inpId, listId) {
    const inp = document.getElementById(inpId);
    const list = document.getElementById(listId);
    if (!inp || !list) return;
    inp.addEventListener('input', () => {
      const q = inp.value.toLowerCase();
      Array.from(list.children).forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  }

  makeSearch('search-admins', 'list-admins');
  makeSearch('search-global-admins', 'list-global-admins');

  const staffSearchUrl = "{{ url_for('admin.search_staff_route') }}";
  let debounce;
  function initStaffSearch(searchId, suggestionsId, hiddenId, buttonId) {
    const staffSearch = document.getElementById(searchId);
    if (!staffSearch) return;

    staffSearch.addEventListener('input', () => {
      clearTimeout(debounce);
      const q = staffSearch.value.trim();
      const sugg = document.getElementById(suggestionsId);
      const addBtn = document.getElementById(buttonId);
      const hidden = document.getElementById(hiddenId);

      if (addBtn) addBtn.disabled = true;
      if (hidden) hidden.value = '';

      const isEmail = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(q);
      if (isEmail) {
        if (hidden) hidden.value = q.toLowerCase();
        if (addBtn) addBtn.disabled = false;
      }

      if (!q) {
        if (sugg) sugg.innerHTML = '';
        return;
      }

      debounce = setTimeout(async () => {
        if (sugg) sugg.innerHTML = '<li class="list-group-item">Searching...</li>';
        try {
          const res = await fetch(`${staffSearchUrl}?q=${encodeURIComponent(q)}`);
          const list = await res.json();
          if (!sugg) return;
          sugg.innerHTML = list.length
            ? list.map(u =>
                `<li class="list-group-item list-group-item-action"
                     onclick="selectStaff('${searchId}','${hiddenId}','${buttonId}','${suggestionsId}','${u.value}','${u.label.replace(/'/g, "\\'")}')">
                   ${u.label}
                 </li>`
              ).join('')
            : '<li class="list-group-item">No staff found</li>';
        } catch {
          if (sugg) sugg.innerHTML = '<li class="list-group-item text-danger">Error</li>';
        }
      }, 300);
    });
  }

  function selectStaff(searchId, hiddenId, buttonId, suggestionsId, email, label) {
    const search = document.getElementById(searchId);
    const hidden = document.getElementById(hiddenId);
    const button = document.getElementById(buttonId);
    const suggestions = document.getElementById(suggestionsId);
    if (search) search.value = label;
    if (hidden) hidden.value = email;
    if (button) button.disabled = false;
    if (suggestions) suggestions.innerHTML = '';
  }

  initStaffSearch('staff-search', 'staff-suggestions', 'new-admin-email', 'add-admin-btn');
  initStaffSearch('global-search', 'global-suggestions', 'new-global-email', 'add-global-btn');
</script>
{% endblock %}
