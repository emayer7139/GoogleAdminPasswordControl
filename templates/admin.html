{% extends "base.html" %}





{% block title %}Admin Console - ResetApp{% endblock %}





{% block extra_css %}


<link href="{{ url_for('static', filename='admin.css') }}" rel="stylesheet" />


{% endblock %}





{% block content %}


<div class="container py-4">


  <div class="admin-hero d-flex flex-wrap align-items-end justify-content-between gap-3">


    <div>


      <h1 class="display-6 mb-1">Admin Console</h1>


      <p class="text-muted mb-0">Audit activity, manage access, and respond to reset requests.</p>


    </div>


    <form class="d-flex flex-wrap gap-2" method="get">


      <input type="date" name="start_date" class="form-control"


             value="{{ request.args.get('start_date','') }}">


      <input type="date" name="end_date" class="form-control"


             value="{{ request.args.get('end_date','') }}">


      <button class="btn btn-primary">Filter</button>


    </form>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.export_data') }}">Export Data</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('status_page') }}">System Status</a>
    </div>


  </div>





  {% set pending_requests = requests_list | selectattr('status', 'equalto', 'Pending') | list | length %}


  <div class="row g-3 mt-2">


    <div class="col-12 col-md-6 col-xl-3">


      <div class="admin-stat">


        <div class="admin-stat-label">Audit Events</div>


        <div class="admin-stat-value">{{ audit_logs|length }}</div>


      </div>


    </div>


    <div class="col-12 col-md-6 col-xl-3">


      <div class="admin-stat">


        <div class="admin-stat-label">Login Events</div>


        <div class="admin-stat-value">{{ login_logs|length }}</div>


      </div>


    </div>


    <div class="col-12 col-md-6 col-xl-3">


      <div class="admin-stat">


        <div class="admin-stat-label">Pending Requests</div>


        <div class="admin-stat-value">{{ pending_requests }}</div>


      </div>


    </div>


    <div class="col-12 col-md-6 col-xl-3">


      <div class="admin-stat">


        <div class="admin-stat-label">Admins</div>


        <div class="admin-stat-value">{{ admin_users|length }}</div>


      </div>


    </div>


    <div class="col-12 col-md-6 col-xl-3">


      <div class="admin-stat">


        <div class="admin-stat-label">Global Admins</div>


        <div class="admin-stat-value">{{ global_admins|length }}</div>


      </div>


    </div>


  </div>





  <div class="admin-tabs mt-4">


    <ul class="nav nav-tabs" id="adminTabs" role="tablist">


      <li class="nav-item" role="presentation">


        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#audit">Audit Logs</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#login">Login Logs</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#users">Students</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminmgmt">Admins</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#requests">Reset Requests</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#bugs">Bug Reports</button>


      </li>


      <li class="nav-item" role="presentation">


        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#known-issues">Known Issues</button>


      </li>


    </ul>





    <div class="tab-content pt-3">


      <div class="tab-pane fade show active" id="audit">


        <form class="row g-2 mb-3" method="get">


          <div class="col-12 col-md-3">


            <select class="form-select" name="audit_role">


              <option value="">All roles</option>


              <option value="teacher" {% if request.args.get('audit_role') == 'teacher' %}selected{% endif %}>Teacher</option>


              <option value="media_specialist" {% if request.args.get('audit_role') == 'media_specialist' %}selected{% endif %}>Media Specialist</option>


              <option value="admin" {% if request.args.get('audit_role') == 'admin' %}selected{% endif %}>Admin</option>


              <option value="global_admin" {% if request.args.get('audit_role') == 'global_admin' %}selected{% endif %}>Global Admin</option>


            </select>


          </div>


          <div class="col-12 col-md-3">


            <input class="form-control" name="audit_school" placeholder="School" value="{{ request.args.get('audit_school','') }}">


          </div>


          <div class="col-12 col-md-3">


            <input class="form-control" name="audit_ou" placeholder="OU contains" value="{{ request.args.get('audit_ou','') }}">


          </div>


          <div class="col-12 col-md-3">


            <button class="btn btn-outline-primary w-100">Filter</button>


          </div>


          <input type="hidden" name="start_date" value="{{ request.args.get('start_date','') }}">


          <input type="hidden" name="end_date" value="{{ request.args.get('end_date','') }}">


        </form>


        <div class="d-flex flex-wrap gap-2 mb-3">


          <a class="btn btn-outline-secondary btn-sm"


             href="{{ url_for('admin.export_audit_csv', start_date=request.args.get('start_date',''), end_date=request.args.get('end_date',''), audit_role=request.args.get('audit_role',''), audit_school=request.args.get('audit_school',''), audit_ou=request.args.get('audit_ou','')) }}">


            Export CSV


          </a>


          <form method="post" action="{{ url_for('admin.set_audit_retention') }}" class="d-flex gap-2">


            <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


            <input type="number" min="1" max="3650" class="form-control form-control-sm" name="retention_days" placeholder="Retention days">


            <button class="btn btn-outline-danger btn-sm">Apply Retention</button>


          </form>


        </div>


        <input id="search-audit" class="form-control mb-3" placeholder="Search audit logs" />


        <div class="table-responsive admin-table">


          <table class="table table-striped" id="tbl-audit">


            <thead>


              <tr><th>Timestamp</th><th>Admin</th><th>Role</th><th>School</th><th>Action</th><th>Details</th></tr>


            </thead>


            <tbody>


              {% for a in audit_logs %}


                <tr>


                  <td>{{ a.timestamp }}</td>


                  <td>{{ a.admin }}</td>


                  <td>{{ a.role or 'Ã¢ÂÂ' }}</td>


                  <td>{{ a.admin_school or 'Ã¢ÂÂ' }}</td>


                  <td>{{ a.outcome }}</td>


                  <td>{{ a.student }}</td>


                </tr>


              {% endfor %}


            </tbody>


          </table>


        </div>


      </div>





      <div class="tab-pane fade" id="login">


        <input id="search-login" class="form-control mb-3" placeholder="Search login events" />


        <div class="table-responsive admin-table">


          <table class="table table-striped" id="tbl-login">


            <thead>


              <tr><th>Timestamp</th><th>User</th><th>Outcome/IP</th></tr>


            </thead>


            <tbody>


              {% for l in login_logs %}


                <tr>


                  <td>{{ l.timestamp }}</td>


                  <td>{{ l.user }}</td>


                  <td>{{ l.outcome }}{% if l.ip %} ({{ l.ip }}){% endif %}</td>


                </tr>


              {% endfor %}


            </tbody>


          </table>


        </div>


      </div>





      <div class="tab-pane fade" id="users">


        <input id="user-search" class="form-control mb-3" placeholder="Search students by name or email" />


        <div class="table-responsive admin-table">


          <table class="table table-striped" id="tbl-users">


            <thead>


              <tr><th>Name</th><th>Email</th></tr>


            </thead>


            <tbody id="user-results"></tbody>


          </table>


        </div>


      </div>





      <div class="tab-pane fade" id="adminmgmt">


        <div class="row g-3">


          <div class="col-12 col-lg-6">


            <h3 class="h5">Current Admins</h3>


            <input id="search-admins" class="form-control mb-3" placeholder="Filter existing admins" />


            <ul class="list-group mb-3" id="list-admins">


              {% for email in admin_users %}


                <li class="list-group-item d-flex justify-content-between align-items-center">


                  {{ email }}


                  {% if email != user.email %}


                    <form method="post" action="{{ url_for('admin.remove_admin') }}"


                          onsubmit="return confirm('Remove {{ email }}?')">


                      <input type="hidden" name="email" value="{{ email }}" />


                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                      <button class="btn btn-sm btn-outline-danger">Remove</button>


                    </form>


                  {% endif %}


                </li>


              {% endfor %}


            </ul>


          </div>


          <div class="col-12 col-lg-6">


            <h3 class="h5">Add Staff as Admin</h3>


            <input id="staff-search" class="form-control mb-2" placeholder="Type staff name or email" />


            <ul class="list-group mb-3" id="staff-suggestions"></ul>


            <form id="add-admin-form" method="post" action="{{ url_for('admin.add_admin') }}"


                  onsubmit="return confirm('Add ' + document.getElementById('new-admin-email').value + ' as admin?')">


              <input type="hidden" id="new-admin-email" name="email" />


              <input type="hidden" name="csrf_token" value="{{session['csrf_token'] }}" />


              <button id="add-admin-btn" class="btn btn-success" disabled>Add Admin</button>


            </form>


          </div>

          {% if role == 'global_admin' %}

          <div class="col-12 col-lg-6">


            <h3 class="h5">Current Global Admins</h3>


            <input id="search-global-admins" class="form-control mb-3" placeholder="Filter global admins" />


            <ul class="list-group mb-3" id="list-global-admins">


              {% for email in global_admins %}


                <li class="list-group-item d-flex justify-content-between align-items-center">


                  {{ email }}


                  {% if email != user.email %}


                    <form method="post" action="{{ url_for('admin.remove_global_admin') }}"


                          onsubmit="return confirm('Remove {{ email }} as global admin?')">


                      <input type="hidden" name="email" value="{{ email }}" />


                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                      <button class="btn btn-sm btn-outline-danger">Remove</button>


                    </form>


                  {% endif %}


                </li>


              {% endfor %}


            </ul>


          </div>


          <div class="col-12 col-lg-6">


            <h3 class="h5">Add Staff as Global Admin</h3>


            <input id="global-search" class="form-control mb-2" placeholder="Type staff name or email" />


            <ul class="list-group mb-3" id="global-suggestions"></ul>


            <form id="add-global-form" method="post" action="{{ url_for('admin.add_global_admin') }}"


                  onsubmit="return confirm('Add ' + document.getElementById('new-global-email').value + ' as global admin?')">


              <input type="hidden" id="new-global-email" name="email" />


              <input type="hidden" name="csrf_token" value="{{session['csrf_token'] }}" />


              <button id="add-global-btn" class="btn btn-warning" disabled>Add Global Admin</button>


            </form>


          </div>

          {% endif %}


        </div>


      </div>





      <div class="tab-pane fade" id="requests">


        <input id="search-requests" class="form-control mb-3" placeholder="Search reset requests" />


        <div class="table-responsive admin-table">


          <table class="table table-striped" id="tbl-requests">


            <thead>


              <tr><th>ID</th><th>Email</th><th>Date</th><th>Status</th><th>Actions</th></tr>


            </thead>


            <tbody>


              {% for r in requests_list %}


                <tr>


                  <td>{{ r.id }}</td>


                  <td>{{ r.email }}</td>


                  <td>{{ r.date }}</td>


                  <td>{{ r.status }}</td>


                  <td>


                    {% if r.status=='Pending' %}


                      <form class="d-inline" method="post" action="{{ url_for('admin.approve_request') }}">


                        <input type="hidden" name="id" value="{{ r.id }}" />


                        <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                        <button class="btn btn-sm btn-primary">Approve</button>


                      </form>


                      <form class="d-inline" method="post" action="{{ url_for('admin.deny_request') }}">


                        <input type="hidden" name="id" value="{{ r.id }}" />


                        <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                        <button class="btn btn-sm btn-outline-secondary">Deny</button>


                      </form>


                    {% endif %}


                  </td>


                </tr>


              {% endfor %}


            </tbody>


          </table>


        </div>


      </div>





      <div class="tab-pane fade" id="bugs">


        <div class="row g-2 mb-3">


          <div class="col-12 col-md-4">


            <input id="search-bugs" class="form-control" placeholder="Search bug reports" />


          </div>


          <div class="col-12 col-md-4">


            <select id="filter-bug-status" class="form-select">


              <option value="">All statuses</option>


              <option value="Open">Open</option>


              <option value="In Progress">In Progress</option>


              <option value="Closed">Closed</option>


            </select>


          </div>


          <div class="col-12 col-md-4">


            <select id="filter-bug-severity" class="form-select">


              <option value="">All severities</option>


              <option value="low">Low</option>


              <option value="medium">Medium</option>


              <option value="high">High</option>


            </select>


          </div>


        </div>


        <div class="table-responsive admin-table">


          <table class="table table-striped" id="tbl-bugs">


            <thead>


              <tr><th>ID</th><th>Timestamp</th><th>Reporter</th><th>Severity</th><th>Title</th><th>Attachment</th><th>Status</th><th>Action</th></tr>


            </thead>


            <tbody>


              {% for b in bug_reports %}


                <tr data-status="{{ b.status }}" data-severity="{{ b.severity }}">


                  <td>{{ b.id }}</td>


                  <td>{{ b.timestamp }}</td>


                  <td>{{ b.reporter }}</td>


                  <td>{{ b.severity }}</td>


                  <td>{{ b.title }}</td>


                  <td>


                    {% if b.attachment %}


                      <a href="{{ url_for('static', filename=b.attachment) }}" target="_blank" class="bug-thumb-link" data-preview="{{ url_for('static', filename=b.attachment) }}">


                        <img src="{{ url_for('static', filename=b.attachment) }}" alt="Bug attachment" class="bug-thumb">


                        <span>Open</span>


                      </a>


                    {% else %}


                      Ã¢ÂÂ


                    {% endif %}


                  </td>


                  <td>{{ b.status }}</td>


                  <td>


                    <form class="d-inline" method="post" action="{{ url_for('admin.update_bug_report_route') }}">


                      <input type="hidden" name="id" value="{{ b.id }}" />


                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                      <select class="form-select form-select-sm d-inline w-auto" name="status">


                        <option value="">Status</option>


                        <option value="Open" {% if b.status == 'Open' %}selected{% endif %}>Open</option>


                        <option value="In Progress" {% if b.status == 'In Progress' %}selected{% endif %}>In Progress</option>


                        <option value="Closed" {% if b.status == 'Closed' %}selected{% endif %}>Closed</option>


                      </select>


                      <button class="btn btn-sm btn-outline-primary ms-1">Save</button>


                    </form>


                  </td>


                </tr>


                <tr class="bug-detail-row" data-status="{{ b.status }}" data-severity="{{ b.severity }}">


                  <td colspan="8" class="small text-muted">


                    <div class="mb-2">{{ b.description }}</div>


                    <form method="post" action="{{ url_for('admin.update_bug_report_route') }}" class="d-flex gap-2 align-items-start">


                      <input type="hidden" name="id" value="{{ b.id }}" />


                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                      <textarea class="form-control form-control-sm" name="notes" rows="2" placeholder="Admin notes">{{ b.notes or '' }}</textarea>


                      <button class="btn btn-sm btn-outline-secondary">Update Notes</button>


                    </form>


                  </td>


                </tr>


              {% endfor %}


            </tbody>


          </table>


        </div>


      </div>





      <div class="tab-pane fade" id="known-issues">


        <div class="row g-3">


          <div class="col-12 col-lg-6">


            <h3 class="h5">Add Known Issue</h3>


            <form method="post" action="{{ url_for('admin.add_known_issue') }}" class="d-flex flex-column gap-2">


              <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


              <select class="form-select" name="level">


                <option value="global">Global banner (main + support)</option>


                <option value="support">Support page only</option>


              </select>


              <textarea class="form-control" name="issue" rows="3" placeholder="Describe the issue for the support banner"></textarea>


              <textarea class="form-control" name="update_note" rows="2" placeholder="Optional update (what we are doing)"></textarea>


              <button class="btn btn-primary align-self-start">Add Issue</button>


            </form>


          </div>


          <div class="col-12 col-lg-6">


            <h3 class="h5">Active Issues</h3>


            <ul class="list-group">


              {% for issue in known_issues if issue.status == 'Active' %}


                <li class="list-group-item d-flex justify-content-between align-items-start gap-3">


                  <div>


                    <div class="fw-semibold">{{ issue.text }}</div>


                    <div class="small text-muted">


                      {{ (issue.level or 'support') | replace('_', ' ') | title }} Â· Added {{ issue.created_at }}


                    </div>


                    {% if issue.update_note %}


                    <div class="small text-muted">Update: {{ issue.update_note }}</div>


                    {% endif %}


                  </div>


                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('admin.resolve_known_issue') }}">
                      <input type="hidden" name="id" value="{{ issue.id }}" />
                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                      <button class="btn btn-sm btn-outline-secondary">Resolve</button>
                    </form>
                    <form method="post" action="{{ url_for('admin.delete_known_issue_route') }}"
                          onsubmit="return confirm('Delete this issue?')">
                      <input type="hidden" name="id" value="{{ issue.id }}" />
                      <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                      <button class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  </div>


                </li>


                <li class="list-group-item">


                  <form method="post" action="{{ url_for('admin.update_known_issue_route') }}" class="d-flex flex-column gap-2">


                    <input type="hidden" name="id" value="{{ issue.id }}" />


                    <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />


                    <input class="form-control form-control-sm" name="issue" value="{{ issue.text }}" />
                    <textarea class="form-control form-control-sm" name="update_note" rows="2" placeholder="Update note">{{ issue.update_note or '' }}</textarea>
                    <div class="d-flex gap-2 align-items-center">
                      <select class="form-select form-select-sm w-auto" name="level">
                        <option value="global" {% if issue.level == 'global' %}selected{% endif %}>Global</option>
                        <option value="support" {% if issue.level != 'global' %}selected{% endif %}>Support</option>
                      </select>
                      <button class="btn btn-sm btn-outline-primary align-self-start">Save Update</button>
                    </div>


                  </form>


                </li>


              {% else %}


                <li class="list-group-item text-muted">No active issues.</li>


              {% endfor %}


            </ul>


          </div>


        </div>





        <div class="mt-4">


          <h3 class="h5">Resolved Issues</h3>


          <div class="table-responsive admin-table">


            <table class="table table-striped">


              <thead>


                <tr><th>Issue</th><th>Added</th><th>Resolved</th></tr>


              </thead>


              <tbody>


                {% for issue in known_issues if issue.status == 'Resolved' %}


                  <tr>


                    <td>{{ issue.text }}</td>


                    <td>{{ issue.created_at }}</td>


                    <td>{{ issue.resolved_at or '' }}</td>


                  </tr>


                {% else %}


                  <tr><td colspan="3" class="text-muted">No resolved issues yet.</td></tr>


                {% endfor %}


              </tbody>


            </table>


          </div>


        </div>


      </div>


    </div>


  </div>


</div>


{% endblock %}





{% block extra_js %}


<script>


  function makeSearch(inpId, tableOrListId) {


    const inp = document.getElementById(inpId);


    const container = document.getElementById(tableOrListId);


    if (!inp || !container) return;


    inp.addEventListener('input', () => {


      const q = inp.value.toLowerCase();


      Array.from(container.children).forEach(row => {


        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';


      });


    });


  }





  makeSearch('search-audit', 'tbl-audit');


  makeSearch('search-login', 'tbl-login');


  makeSearch('search-admins', 'list-admins');


  makeSearch('search-global-admins', 'list-global-admins');


  makeSearch('search-requests', 'tbl-requests');





  let debounce;


  const userSearch = document.getElementById('user-search');


  if (userSearch) {


    userSearch.addEventListener('input', () => {


      clearTimeout(debounce);


      const q = userSearch.value.trim();


      const tbody = document.getElementById('user-results');


      if (!q) return tbody.innerHTML = '';


      debounce = setTimeout(async () => {


        tbody.innerHTML = '<tr><td colspan="2">Searching...</td></tr>';


        try {


          const res = await fetch(`/search_users?q=${encodeURIComponent(q)}`);


          const users = await res.json();


          tbody.innerHTML = users.length


            ? users.map(u => `<tr><td>${u.label}</td><td>${u.value}</td></tr>`).join('')


            : '<tr><td colspan="2">No students found</td></tr>';


        } catch {


          tbody.innerHTML = '<tr><td colspan="2">Error</td></tr>';


        }


      }, 300);


    });


  }





    function initStaffSearch(searchId, suggestionsId, hiddenId, buttonId) {

    const staffSearch = document.getElementById(searchId);

    if (!staffSearch) return;

    staffSearch.addEventListener('input', () => {

      clearTimeout(debounce);

      const q = staffSearch.value.trim();

      const sugg = document.getElementById(suggestionsId);

      const addBtn = document.getElementById(buttonId);

      const hidden = document.getElementById(hiddenId);

      if (addBtn) addBtn.disabled = true;

      if (hidden) hidden.value = '';

      if (!q) {

        if (sugg) sugg.innerHTML = '';

        return;

      }

      debounce = setTimeout(async () => {

        if (sugg) sugg.innerHTML = '<li class="list-group-item">Searching...</li>';

        try {

          const res = await fetch(`/search_staff?q=${encodeURIComponent(q)}`);

          const list = await res.json();

          if (!sugg) return;

          sugg.innerHTML = list.length

            ? list.map(u =>

                `<li class="list-group-item list-group-item-action"

                     onclick="selectStaff('${searchId}','${hiddenId}','${buttonId}','${suggestionsId}','${u.value}','${u.label.replace(/'/g, "\\'")}')">

                   ${u.label}

                 </li>`

              ).join('')

            : '<li class="list-group-item">No staff found</li>';

        } catch {

          if (sugg) sugg.innerHTML = '<li class="list-group-item text-danger">Error</li>';

        }

      }, 300);

    });

  }

  function selectStaff(searchId, hiddenId, buttonId, suggestionsId, email, label) {

    const search = document.getElementById(searchId);

    const hidden = document.getElementById(hiddenId);

    const button = document.getElementById(buttonId);

    const suggestions = document.getElementById(suggestionsId);

    if (search) search.value = label;

    if (hidden) hidden.value = email;

    if (button) button.disabled = false;

    if (suggestions) suggestions.innerHTML = '';

  }

  initStaffSearch('staff-search', 'staff-suggestions', 'new-admin-email', 'add-admin-btn');

  initStaffSearch('global-search', 'global-suggestions', 'new-global-email', 'add-global-btn');




const bugSearch = document.getElementById('search-bugs');


  const bugStatus = document.getElementById('filter-bug-status');


  const bugSeverity = document.getElementById('filter-bug-severity');


  const bugRows = () => Array.from(document.querySelectorAll('#tbl-bugs tbody tr'));





  function filterBugs() {


    const q = (bugSearch?.value || '').toLowerCase();


    const status = bugStatus?.value || '';


    const severity = bugSeverity?.value || '';


    const rows = bugRows();


    for (let i = 0; i < rows.length; i++) {


      const row = rows[i];


      const text = row.textContent.toLowerCase();


      const rowStatus = row.dataset.status || '';


      const rowSeverity = row.dataset.severity || '';


      const matches = (!q || text.includes(q)) &&


        (!status || rowStatus === status) &&


        (!severity || rowSeverity === severity);


      row.style.display = matches ? '' : 'none';


    }


  }





  if (bugSearch) bugSearch.addEventListener('input', filterBugs);


  if (bugStatus) bugStatus.addEventListener('change', filterBugs);


  if (bugSeverity) bugSeverity.addEventListener('change', filterBugs);





  const previewLinks = document.querySelectorAll('.bug-thumb-link[data-preview]');


  previewLinks.forEach(link => {


    link.addEventListener('click', (event) => {


      event.preventDefault();


      const src = link.dataset.preview;


      const img = document.getElementById('bugPreviewImg');


      if (img) img.src = src;


      const modalEl = document.getElementById('bugPreviewModal');


      if (modalEl) {


        const modal = new bootstrap.Modal(modalEl);


        modal.show();


      }


    });


  });


</script>





<div class="modal fade" id="bugPreviewModal" tabindex="-1" aria-hidden="true">


  <div class="modal-dialog modal-dialog-centered modal-lg">


    <div class="modal-content">


      <div class="modal-header">


        <h5 class="modal-title">Bug Attachment</h5>


        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>


      </div>


      <div class="modal-body text-center">


        <img id="bugPreviewImg" src="" alt="Bug attachment preview" class="img-fluid rounded">


      </div>


    </div>


  </div>


</div>


{% endblock %}





