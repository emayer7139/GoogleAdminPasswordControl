{% extends "admin_layout.html" %}

{% set page_title = "Known Issues" %}

{% block admin_header %}
<div class="admin-hero d-flex flex-wrap align-items-end justify-content-between gap-3">
  <div>
    <h1 class="display-6 mb-1">Known Issues</h1>
    <p class="text-muted mb-0">Manage support banners and issue updates.</p>
  </div>
</div>
{% endblock %}

{% block admin_body %}
<div class="admin-panel mt-3">
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <h3 class="h5">Add Known Issue</h3>
      <form method="post" action="{{ url_for('admin.add_known_issue') }}" class="d-flex flex-column gap-2">
        <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
        <select class="form-select" name="level">
          <option value="global">Global banner (main + support)</option>
          <option value="support">Support page only</option>
        </select>
        <textarea class="form-control" name="issue" rows="3" placeholder="Describe the issue for the support banner"></textarea>
        <textarea class="form-control" name="update_note" rows="2" placeholder="Optional update (what we are doing)"></textarea>
        <button class="btn btn-primary align-self-start">Add Issue</button>
      </form>
    </div>
    <div class="col-12 col-lg-6">
      <h3 class="h5">Active Issues</h3>
      <ul class="list-group">
        {% for issue in known_issues if issue.status == 'Active' %}
          <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ issue.text }}</div>
              <div class="small text-muted">
                {{ (issue.level or 'support') | replace('_', ' ') | title }} &middot; Added {{ issue.created_at }}
              </div>
              {% if issue.update_note %}
              <div class="small text-muted">Update: {{ issue.update_note }}</div>
              {% endif %}
            </div>
            <div class="d-flex gap-2">
              <form method="post" action="{{ url_for('admin.resolve_known_issue') }}">
                <input type="hidden" name="id" value="{{ issue.id }}" />
                <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                <button class="btn btn-sm btn-outline-secondary">Resolve</button>
              </form>
              <form method="post" action="{{ url_for('admin.delete_known_issue_route') }}"
                    onsubmit="return confirm('Delete this issue?')">
                <input type="hidden" name="id" value="{{ issue.id }}" />
                <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </div>
          </li>
          <li class="list-group-item">
            <form method="post" action="{{ url_for('admin.update_known_issue_route') }}" class="d-flex flex-column gap-2">
              <input type="hidden" name="id" value="{{ issue.id }}" />
              <input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}" />
              <input class="form-control form-control-sm" name="issue" value="{{ issue.text }}" />
              <textarea class="form-control form-control-sm" name="update_note" rows="2" placeholder="Update note">{{ issue.update_note or '' }}</textarea>
              <div class="d-flex gap-2 align-items-center flex-wrap">
                <select class="form-select form-select-sm w-auto" name="level">
                  <option value="global" {% if issue.level == 'global' %}selected{% endif %}>Global</option>
                  <option value="support" {% if issue.level != 'global' %}selected{% endif %}>Support</option>
                </select>
                <button class="btn btn-sm btn-outline-primary align-self-start">Save Update</button>
              </div>
            </form>
          </li>
        {% else %}
          <li class="list-group-item text-muted">No active issues.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="admin-panel mt-4">
  <h3 class="h5 mb-3">Resolved Issues</h3>
  <div class="table-responsive admin-table">
    <table class="table table-striped">
      <thead>
        <tr><th>Issue</th><th>Added</th><th>Resolved</th></tr>
      </thead>
      <tbody>
        {% for issue in known_issues if issue.status == 'Resolved' %}
          <tr>
            <td>{{ issue.text }}</td>
            <td>{{ issue.created_at }}</td>
            <td>{{ issue.resolved_at or '' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="3" class="text-muted">No resolved issues yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
